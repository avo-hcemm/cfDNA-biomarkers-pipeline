<?xml version="1.0" encoding="UTF-8"?>
<tool id="test_module2to6" name="Run test Modules 2–6" version="1.5.0">
  <description>Run biomarker discovery (modules 2–6) per chromosome</description>

   <requirements>
        <container type="docker">avohcemm/biomarkersearch-mod1to6:latest</container>
    </requirements>

  <environment_variables>
        <environment_variable name="input_dir">module2to6</environment_variable>
        <environment_variable name="working_dir">module2to6</environment_variable>
    </environment_variables>

  <command><![CDATA[
    mkdir -p "\$working_dir/jars" "\$working_dir/config" "\$working_dir/input" "\$working_dir/src/genome/human/hg38" "\$working_dir/KL_output" "\$working_dir/CNA_compositions" &&

    cp "$__tool_directory__/jcna-kldiv_16.3.jar" "\$working_dir/jars/jcna-kldiv_16.3.jar" 2> debug_files_upload.txt && 
    cp "$__tool_directory__/log4j2.xml" "\$working_dir/config/log4j2.xml" 2>> debug_files_upload.txt && 
    cp -r $__tool_directory__/genome/human/hg38/* "\$working_dir/src/genome/human/hg38" 2>> debug_files_upload.txt && 

    cp "${genomeinfo}" "\$working_dir/input/genome.csv" 2>> debug_files_upload.txt &&
    echo "Genome data copy succeeded" >> debug_files_upload.txt || echo "Genome data copy failed" >> debug_files_upload.txt &&
    cp "${parametersinfo}" "\$working_dir/input/param.csv" 2> debug_files_upload.txt &&
    echo "Parameters data copy succeeded" >> debug_files_upload.txt || echo "Parameters data copy failed" >> debug_files_upload.txt &&

    ls -lh \${working_dir} >> debug_files_upload.txt &&

    #if $datainfo and $datainfo != "None"
      echo "Data info provided: ${datainfo}." >> debug_files_upload.txt &&
      cp "${datainfo}" "\$working_dir/input/data.csv" 2>> debug_files_upload.txt &&
      echo "Samples data copy succeeded" >> debug_files_upload.txt || echo "Samples data copy failed" >> debug_files_upload.txt &&

      bash "$__tool_directory__/run_pipeline_module2to6.sh" \
      -i "\$input_dir" \
      -o "\$working_dir" \
      "input/genome.csv" \
      "input/param.csv" \
      "input/data.csv" \
      "${species}" \
      --chromosome "${chromosome}" 

    #else
      echo "No data info provided." >> debug_files_upload.txt &&
      bash "$__tool_directory__/run_pipeline_module2to6.sh" \
      -i "\$input_dir" \
      -o "\$working_dir" \
      "input/genome.csv" \
      "input/param.csv" \
      "" \
      "${species}" \
      --chromosome "${chromosome}" 
    #end if

  ]]></command>


  <inputs>
    <param name="genomeinfo" type="data" format="csv" label="Genome Info CSV" />
    <param name="parametersinfo" type="data" format="csv" label="Parameters Info CSV" />
    <param name="datainfo" type="data" format="csv" optional="true" label="Data Info CSV (optional)" />
    <param name="species" type="text" label="Species" />
    <param name="chromosome" type="text" label="Chromosome" />
  </inputs>

  <outputs>
    <data name="debug_output" format="txt" label="Debug Output" from_work_dir="debug_files_upload.txt"/>
  </outputs>

  <help><![CDATA[
This tool runs **Modules 2–6** of the biomarker discovery pipeline.

### What it does
- Uses BAM files generated by **Module 1**, located in `module2to6/samples/`.
- Uses genome/parameter/configuration CSV files provided by the user.
- Computes KL divergence and CNA composition for a given chromosome.
- Results are written under `module2to6/`.

### Inputs
- **Genome Info CSV**: Genome configuration.
- **Parameters Info CSV**: Pipeline parameters.
- **Data Info CSV** *(optional)*: Sample metadata.
- **Species**: Target species (e.g., human, mouse).
- **Chromosome**: Chromosome to process.

### Outputs
- **KL divergence results**: Stored in `module2to6/KL_output/`.
- **CNA composition results**: Stored in `module2to6/CNA_compositions/`.
  ]]></help>
</tool>
