<?xml version="1.0" encoding="UTF-8"?>
<tool id="basic printing to files" name="Basic Tool 1" version="2.1.6">
    <description>Run preprocessing with extracted inputs</description>

    <requirements>
        <container type="docker">avohcemm/pipeline_env:latest</container>
    </requirements>

    <environment_variables>
        <environment_variable name="output_subdir">module2to6/samples</environment_variable>
    </environment_variables>

    <command><![CDATA[
    mkdir -p working_dir/genome_index_path "\$output_subdir" > debug_files_upload.txt 2>&1 || echo "mkdir failed" >> debug_files_upload.txt &&

    cp "${pathtodata}" working_dir/input.tar.gz 2>> debug_files_upload.txt &&
    echo "Data Copy succeeded" >> debug_files_upload.txt || echo "Data Copy failed" >> debug_files_upload.txt &&
    cp "${genomeindextar}" working_dir/genome_index_path/genome.tar.gz 2>> debug_files_upload.txt &&
    echo "Genome Copy succeeded" >> debug_files_upload.txt || echo "Genome Copy failed" >> debug_files_upload.txt &&
    cp "${adapterfile}" working_dir/adapter.fasta 2>> debug_files_upload.txt &&
    echo "Adapter Copy succeeded" >> debug_files_upload.txt || echo "Adapter Copy failed" >> debug_files_upload.txt &&

    tar --strip-components=1 -xzf working_dir/input.tar.gz -C working_dir &&
    echo "Extraction succeeded" >> debug_files_upload.txt|| echo "Extraction failed" >> debug_files_upload.txt &&

    tar -xzf working_dir/genome_index_path/genome.tar.gz -C working_dir/genome_index_path &&
    echo "Extraction succeeded" >> debug_files_upload.txt || echo "Extraction failed" >> debug_files_upload.txt &&

    echo "After copying and extraction input:" >> debug_files_upload.txt &&
    ls -lh working_dir >> debug_files_upload.txt &&
    ls -lh working_dir/genome_index_path >> debug_files_upload.txt &&

    echo "\$output_subdir" >> debug_files_upload.txt &&
    echo "Command: $__tool_directory__/reads_preprocessing.sh working_dir ${datasubdir} working_dir/adapter.fasta working_dir/genome_index_path -o \$output_subdir" >> debug_files_upload.txt &&
    bash $__tool_directory__/reads_preprocessing.sh working_dir ${datasubdir} working_dir/adapter.fasta working_dir/genome_index_path -o "\$output_subdir"
    
    ]]></command>

    <inputs>
        <param name="pathtodata" type="data" format="tar.gz" label="Compressed Data Directory (.tar.gz)" />
        <param name="datasubdir" type="text" label="Data Subdirectory" help="Subdirectory within the data folder (e.g., 'test_batch2025')." />
        <param name="adapterfile" type="data" format="fasta" label="Adapter File" help="Upload adapter FASTA file for trimming." />
        <param name="genomeindextar" type="data" format="tar.gz" label="Genome index (Bowtie2)" />
    </inputs>

    <outputs>
        <!-- At least one guaranteed output -->
        <data name="debug_output" format="txt" label="Debug Output" from_work_dir="debug_files_upload.txt"/>
    </outputs>

    <help><![CDATA[
This tool extracts your input text message and writes a debug log with the executed command and extracted contents.
    ]]></help>
</tool>
